{
    "version": 3,
    "sources": [
        "../../../src/api/controller/comment.js"
    ],
    "names": [
        "Base",
        "require",
        "module",
        "exports",
        "postAction",
        "typeId",
        "post",
        "valueId",
        "content",
        "buffer",
        "Buffer",
        "insertId",
        "model",
        "add",
        "type_id",
        "value_id",
        "toString",
        "add_time",
        "getTime",
        "user_id",
        "getLoginUserId",
        "success",
        "fail",
        "countAction",
        "get",
        "allCount",
        "where",
        "count",
        "hasPicCount",
        "alias",
        "join",
        "table",
        "on",
        "listAction",
        "showType",
        "page",
        "size",
        "comments",
        "countSelect",
        "field",
        "commentList",
        "commentItem",
        "data",
        "comment",
        "id",
        "think",
        "datetime",
        "Date",
        "user_info",
        "find",
        "pic_list",
        "comment_id",
        "select",
        "push"
    ],
    "mappings": "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",
    "file": "../../../src/api/controller/comment.js",
    "sourcesContent": [
        "const Base = require('./base.js');\n\nmodule.exports = class extends Base {\n  /**\n   * 评论类型说明：\n   * 0 商品\n   * 1 专题\n   */\n\n  /**\n   * 发表评论\n   * @returns {Promise.<*|PreventPromise|void|Promise>}\n   */\n  async postAction() {\n    const typeId = this.post('typeId');\n    const valueId = this.post('valueId');\n    const content = this.post('content');\n    const buffer = new Buffer(content);\n    const insertId = await this.model('comment').add({\n      type_id: typeId,\n      value_id: valueId,\n      content: buffer.toString('base64'),\n      add_time: this.getTime(),\n      user_id: this.getLoginUserId()\n    });\n\n    if (insertId) {\n      return this.success('评论添加成功');\n    } else {\n      return this.fail('评论保存失败');\n    }\n  }\n\n  async countAction() {\n    const typeId = this.get('typeId');\n    const valueId = this.get('valueId');\n\n    const allCount = await this.model('comment').where({type_id: typeId, value_id: valueId}).count('id');\n\n    const hasPicCount = await this.model('comment').alias('comment')\n      .join({\n        table: 'comment_picture',\n        join: 'right',\n        alias: 'comment_picture',\n        on: ['id', 'comment_id']\n      }).where({'comment.type_id': typeId, 'comment.value_id': valueId}).count('comment.id');\n\n    return this.success({\n      allCount: allCount,\n      hasPicCount: hasPicCount\n    });\n  }\n\n  async listAction() {\n    const typeId = this.get('typeId');\n    const valueId = this.get('valueId');\n    const showType = this.get('showType'); // 选择评论的类型 0 全部， 1 只显示图片\n\n    const page = this.get('page');\n    const size = this.get('size');\n\n    let comments = [];\n    if (showType !== 1) {\n      comments = await this.model('comment').where({\n        type_id: typeId,\n        value_id: valueId\n      }).page(page, size).countSelect();\n    } else {\n      comments = await this.model('comment').alias('comment')\n        .field(['comment.*'])\n        .join({\n          table: 'comment_picture',\n          join: 'right',\n          alias: 'comment_picture',\n          on: ['id', 'comment_id']\n        }).page(page, size).where({'comment.type_id': typeId, 'comment.value_id': valueId}).countSelect();\n    }\n\n    const commentList = [];\n    for (const commentItem of comments.data) {\n      const comment = {};\n      comment.content = new Buffer(commentItem.content, 'base64').toString();\n      comment.type_id = commentItem.type_id;\n      comment.value_id = commentItem.value_id;\n      comment.id = commentItem.id;\n      comment.add_time = think.datetime(new Date(commentItem.add_time * 1000));\n      comment.user_info = await this.model('user').field(['username', 'avatar', 'nickname']).where({id: commentItem.user_id}).find();\n      comment.pic_list = await this.model('comment_picture').where({comment_id: commentItem.id}).select();\n      commentList.push(comment);\n    }\n    comments.data = commentList;\n    return this.success(comments);\n  }\n};\n"
    ]
}